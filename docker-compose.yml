version: "3.8"
services:
  robotics-dev:
    env_file: ./.env
    image: robotics-dev:latest
    container_name: robotics_dev
    build:
      context: .
      network: host
      dockerfile: Dockerfile
      args:
        http_proxy: ${http_proxy}
        https_proxy: ${https_proxy}
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        COMPILE_JOBS: ${COMPILE_JOBS}
        OS: ${OS}
        ROS_DISTRO: ${ROS_DISTRO}
        ROS_DISTRO_TAG: ${ROS_DISTRO_TAG}
        CMAKE_VERSION: ${CMAKE_VERSION}
        PYTHON3_VERSION: ${PYTHON3_VERSION}
        OPENCV3_VERSION: ${OPENCV3_VERSION}
        OPENCV4_VERSION: ${OPENCV4_VERSION}
        EIGEN_VERSION: ${EIGEN_VERSION}
        CERES_VERSION: ${CERES_VERSION}
        NEOVIM_VERSION: ${NEOVIM_VERSION}
        TMUX_VERSION: ${TMUX_VERSION}
        USER: ${USER}
        UID: ${UID}
        GID: ${GID}
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]
    user: ${UID}:${GID}
    network_mode: host
    ipc: host
    privileged: true
    stdin_open: true
    tty: true
    volumes:
      # x11 socket
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # nvim configuration
      - ~/.config/nvim/:${HOME}/.config/nvim/:ro
      # tmux configuration
      - ~/.tmux.conf:${HOME}/.tmux.conf:ro
      # git configuration
      - ~/.gitconfig:${HOME}/.gitconfig:ro
    restart: always
